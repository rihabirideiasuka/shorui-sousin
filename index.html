<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</title>
<style>
  *,*::before,*::after{ box-sizing:border-box; }
  :root{ --primary:#1556d1; --danger:#c62828; --ok:#137333; --fg:#111; --muted:#666; --bg:#f6f7fb; --card:#fff; }
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif;line-height:1.6;margin:0}
  .wrap{max-width:880px;margin:0 auto;padding:20px}
  .card{background:var(--card);border-radius:18px;box-shadow:0 2px 14px rgba(0,0,0,.06);padding:20px}
  h1{font-size:22px;margin:0 0 8px}
  label{display:block;font-weight:600;margin:14px 0 6px}
  input[type="text"]{width:100%;max-width:100%;padding:14px 16px;border:1px solid #ddd;border-radius:14px;font-size:16px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  .btn{appearance:none;border:0;border-radius:14px;padding:14px 16px;font-weight:700;font-size:16px;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-plain{background:#eef3ff;color:#183a9b}
  .btn-danger{background:#feecec;color:#a12121}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .hint{font-size:14px;color:var(--muted);margin:6px 0 0}
  .msg{padding:12px 14px;border-radius:12px;margin:10px 0;font-size:16px}
  .msg-ok{background:#e9f5ee;color:var(--ok);border:1px solid #bfe5cd}
  .msg-bad{background:#fdecec;color:var(--danger);border:1px solid #f3c3c0}
  .msg-info{background:#eef3ff;color:#274291;border:1px solid #cfdcff}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:10px}
  .thumb{background:#fafafa;border:1px solid #eee;border-radius:14px;overflow:hidden}
  .thumb img{width:100%;height:120px;object-fit:cover;display:block;background:#fff}
  .thumb .meta{padding:8px 10px;font-size:14px}
  .thumb .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .remove{background:#ffe7e7;color:#a12121;border:0;border-radius:10px;padding:6px 8px;font-weight:700;cursor:pointer}
  .progress{height:10px;background:#e8eefc;border-radius:999px;overflow:hidden;margin:10px 0 0}
  .bar{width:40%;height:100%;background:var(--primary);animation:indef 1.2s infinite}
  @keyframes indef{0%{transform:translateX(-60%)}100%{transform:translateX(160%)}}
  .done{display:none;margin-top:14px}
  .done.show{display:block}
  .done h2{margin:0 0 6px;font-size:22px}
  .done .sub{margin:0;color:#333}
  .big{font-size:18px}

  /* ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒœã‚¿ãƒ³ã®å±…å ´æ‰€ã‚’ç¢ºä¿ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal.show{display:flex}
  .cam{
    background:#000;border-radius:16px;max-width:640px;width:100%;
    color:#fff;display:flex;flex-direction:column;
    max-height:calc(100vh - 20px); padding:12px;
  }
  .cam video{
    width:100%;background:#000;border-radius:12px;
    flex:1 1 auto; max-height:calc(100vh - 220px); object-fit:cover;
  }
  .cam .controls{
    display:flex;gap:10px;justify-content:space-between;margin-top:10px;
    position:sticky;bottom:0;background:rgba(0,0,0,.65);
    padding:12px;border-radius:12px;
  }
  .cam .btn{flex:1}
  @supports (padding: env(safe-area-inset-bottom)) {
    .cam .controls{ padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>

    <form id="f" autocomplete="off" novalidate>
      <label class="big">åˆ©ç”¨è€…åãƒ»CMå ç­‰ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="note" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒï¼CMåï¼äº‹æ¥­æ‰€å ãªã©">

      <label class="big">å†™çœŸãƒ»PDF</label>
      <div class="btns">
        <input id="pick" type="file" accept="image/jpeg,image/png,application/pdf" multiple style="display:none">
        <button type="button" class="btn btn-primary" id="pickBtn">ğŸ“ ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰å†™çœŸã‚’é¸æŠã—ã¦é€ã‚‹</button>

        <input id="cameraFile" type="file" accept="image/*" capture="environment" style="display:none">
        <button type="button" class="btn btn-plain" id="camBtn">ğŸ“¸ å†™çœŸã‚’æ’®å½±ã—ã¦é€ã‚‹ï¼ˆ1æšãšã¤ï¼‰</button>

        <button type="button" class="btn btn-danger" id="clearBtn">âœ– ã™ã¹ã¦å‰Šé™¤</button>
      </div>
      <p class="hint">â€» 1ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šé™ï¼š<strong>25MB</strong>ã€€å¯¾å¿œå½¢å¼ï¼š<strong>jpeg / png / pdf</strong></p>

      <div id="precheck" class="msg msg-info" role="status" aria-live="polite">é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      <div class="thumbs" id="thumbs" aria-live="polite"></div>

      <div class="btns" style="margin-top:14px">
        <button class="btn btn-primary big" id="sendBtn" type="submit" disabled>â¬† é€ä¿¡ã™ã‚‹</button>
      </div>

      <div id="sending" class="msg msg-info" style="display:none" role="status" aria-live="assertive">
        â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚
        <div class="progress"><div class="bar"></div></div>
      </div>

      <div id="done" class="msg msg-ok done" role="status" aria-live="assertive">
        <h2>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆæˆåŠŸï¼‰</h2>
        <p class="sub" id="doneCount"></p>
      </div>
    </form>
  </div>
</div>

<!-- ã‚«ãƒ¡ãƒ©ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="camModal" class="modal" aria-hidden="true">
  <div class="cam" role="dialog" aria-label="ã‚«ãƒ¡ãƒ©ã§æ’®å½±">
    <video id="camVideo" autoplay playsinline></video>
    <div class="controls">
      <button type="button" class="btn" id="camClose">é–‰ã˜ã‚‹</button>
      <button type="button" class="btn btn-primary" id="camShot">æ’®å½±ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
  // ===== è¨­å®š =====
  const API_ENDPOINT = 'https://script.google.com/macros/s/ã€GASã®exec URLã€‘/exec';
  const ALLOW_MIME = ['image/jpeg', 'image/png', 'application/pdf'];
  const MAX_BYTES = 25 * 1024 * 1024; // 25MB

  // ===== UI =====
  const queue = [];
  const $ = s => document.querySelector(s);

  const pickInput = $('#pick');
  const cameraFile = $('#cameraFile'); // éå¯¾å¿œ/æ‹’å¦æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const thumbs = $('#thumbs'), precheck = $('#precheck');
  const sendBtn = $('#sendBtn'), sending = $('#sending');
  const doneBox = $('#done'), doneCount = $('#doneCount');

  // ã‚«ãƒ¡ãƒ©UI
  const camModal = $('#camModal'), camVideo = $('#camVideo');
  const camClose = $('#camClose'), camShot = $('#camShot');
  let camStream = null;

  $('#pickBtn').onclick = () => pickInput.click();
  $('#camBtn').onclick  = () => openCameraOrFallback();
  $('#clearBtn').onclick= () => { queue.length = 0; render(); };

  pickInput.addEventListener('change', (e) => {
    for (const f of e.target.files) queue.push(f);
    e.target.value = ''; render();
  });
  cameraFile.addEventListener('change', (e) => {
    if (e.target.files[0]) queue.push(e.target.files[0]);
    e.target.value = ''; render();
  });

  async function openCameraOrFallback(){
    if (!navigator.mediaDevices?.getUserMedia){
      cameraFile.click(); return;
    }
    try {
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } }, audio: false
      });
      camVideo.srcObject = camStream;
      camModal.classList.add('show'); camModal.setAttribute('aria-hidden','false');
      setTimeout(() => window.scrollTo({ top: 90, left: 0, behavior: 'auto' }), 80);
      document.body.style.overflow = 'hidden';
    } catch (e){
      cameraFile.click();
    }
  }
  function stopCamera(){
    if (camStream){ camStream.getTracks().forEach(t => t.stop()); camStream = null; }
    camVideo.srcObject = null;
    camModal.classList.remove('show'); camModal.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }
  camClose.onclick = () => stopCamera();
  camShot.onclick  = async () => {
    if (!camStream) return;
    const track = camStream.getVideoTracks()[0];
    const s = track.getSettings ? track.getSettings() : {};
    const w = s.width || camVideo.videoWidth || 1280;
    const h = s.height || camVideo.videoHeight || 720;
    const c = document.createElement('canvas'); c.width = w; c.height = h;
    c.getContext('2d').drawImage(camVideo, 0, 0, w, h);
    const blob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.92));
    const name = buildCamName_();
    queue.push(new File([blob], name, { type: 'image/jpeg' }));
    stopCamera(); render();
  };
  function buildCamName_(){
    const d=new Date(), z=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}.jpg`;
  }

  function render(){
    thumbs.innerHTML = '';
    if (queue.length > 0) doneBox.classList.remove('show');

    if (!queue.length){
      precheck.className = 'msg msg-info';
      precheck.textContent = 'é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
      sendBtn.disabled = true; return;
    }

    queue.forEach((f, idx) => {
      const card = document.createElement('div'); card.className = 'thumb';
      const img = document.createElement('img');
      if ((f.type||'').startsWith('image/')){
        img.src = URL.createObjectURL(f); img.onload = ()=> URL.revokeObjectURL(img.src);
      } else { img.alt='ãƒ•ã‚¡ã‚¤ãƒ«'; img.style.background='#eef3ff'; }
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML =
        '<div class="row"><strong>' + escapeHtml(f.name) + '</strong></div>' +
        '<div class="row"><span>' + (f.size/1024/1024).toFixed(1) + ' MB</span>' +
        '  <button type="button" class="remove" aria-label="ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤" data-i="' + idx + '">å‰Šé™¤</button>' +
        '</div>';
      card.appendChild(img); card.appendChild(meta); thumbs.appendChild(card);
    });
    document.querySelectorAll('.remove').forEach(btn => {
      btn.onclick = (e)=>{ const i = Number(e.currentTarget.getAttribute('data-i')); queue.splice(i,1); render(); };
    });

    // äº‹å‰ãƒã‚§ãƒƒã‚¯
    const badType = queue.filter(f => ALLOW_MIME.indexOf((f.type||'').toLowerCase()) === -1);
    if (badType.length){
      precheck.className = 'msg msg-bad';
      precheck.innerHTML = 'âš  é€ä¿¡ã§ããªã„å½¢å¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆjpeg/png/pdfã®ã¿ï¼‰ã€‚';
      sendBtn.disabled = true; return;
    }
    const badSize = queue.filter(f => f.size > MAX_BYTES);
    if (badSize.length){
      precheck.className = 'msg msg-bad';
      const names = badSize.map(f => `${escapeHtml(f.name)}ï¼ˆ${(f.size/1024/1024).toFixed(1)}MBï¼‰`).join('ã€ ');
      precheck.innerHTML = `âš  ä¸Šé™<strong>${Math.round(MAX_BYTES/1024/1024)}MB</strong>ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼š<br>${names}<br>å°ã•ãæ’®ã‚Šç›´ã™ã‹ã€åˆ†ã‘ã¦é€ã£ã¦ãã ã•ã„ã€‚`;
      sendBtn.disabled = true; return;
    }
    const sum = queue.reduce((s,f)=>s+f.size,0);
    precheck.className = 'msg msg-ok';
    precheck.innerHTML = `ğŸ‘ é€ä¿¡ã§ãã¾ã™ã€‚é¸æŠæšæ•°ï¼š<strong>${queue.length}</strong>ã€åˆè¨ˆï¼šç´„<strong>${(sum/1024/1024).toFixed(1)}MB</strong>`;
    sendBtn.disabled = false;
  }

  // ---- é€ä¿¡ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ãšã¤ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ã«é€ã‚‹ï¼šå¤§ãã„ãƒœãƒ‡ã‚£ã‚’é¿ã‘ã‚‹ï¼‰ ----
  document.getElementById('f').addEventListener('submit', (e) => {
    e.preventDefault();
    if (!queue.length){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    (async () => {
      try {
        sendBtn.disabled = true; sending.style.display = 'block';
        const note = document.getElementById('note').value || '';
        let okCount = 0;

        for (const f of queue) {
          // ç”»åƒã¯æœ€å¤§2000pxã¸ç¸®å°ãƒ»å†åœ§ç¸®
          const packed = await toBase64WithOptionalResize(f);
          if (packed.bytes > MAX_BYTES) {
            throw new Error(`${f.name} ãŒä¸Šé™ï¼ˆ${(MAX_BYTES/1024/1024).toFixed(1)}MBï¼‰ã‚’è¶…ãˆã¾ã™ã€‚ã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`);
          }
          const payload = { note, items: [{ name: f.name, mime: packed.mime, base64: packed.base64 }] };

          const resp = await fetch(API_ENDPOINT, {
            method: 'POST',
            // ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆã‚’é¿ã‘ã‚‹ãŸã‚ application/json ã§ã¯ãªã text/plain
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          if (!data.ok) throw new Error(data.error || 'UPLOAD_FAILED');
          okCount += data.count || 0;
        }

        sending.style.display = 'none';
        doneBox.classList.add('show');
        doneCount.innerHTML = `é€ä¿¡ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°ï¼š<strong>${okCount}</strong>`;
        queue.length = 0; render();
      } catch (err) {
        sending.style.display = 'none';
        alert(err && err.message ? err.message : err);
        sendBtn.disabled = false;
      }
    })();
  });

  // --- ç”»åƒã¯æœ€å¤§2000pxã¸ç¸®å°ã€‚éç”»åƒã¯DataURLåŒ– ---
  async function toBase64WithOptionalResize(file){
    if ((file.type||'').startsWith('image/')){
      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      const maxW=2000,maxH=2000;
      const scale = Math.min(1, maxW/img.width, maxH/img.height);
      let outUrl = dataUrl, mimeOut = (file.type==='image/png'?'image/png':'image/jpeg');
      if (scale < 1){
        const c=document.createElement('canvas');
        c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        outUrl=c.toDataURL(mimeOut,0.9);
      } else if (!/^image\/(png|jpeg)$/i.test(file.type)) {
        mimeOut = file.type || 'application/octet-stream';
      }
      const base64=outUrl.split(',')[1];
      const bytes = Math.ceil(base64.length*3/4);
      return { base64, bytes, mime: mimeOut };
    } else {
      if (file.size>MAX_BYTES){
        throw new Error(`${file.name} ãŒä¸Šé™ï¼ˆ${(MAX_BYTES/1024/1024).toFixed(1)}MBï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
      }
      const dataUrl=await readFileAsDataURL(file);
      const base64=dataUrl.split(',')[1];
      const bytes=Math.ceil(base64.length*3/4);
      return { base64, bytes, mime:(file.type||'application/octet-stream') };
    }
  }
  function readFileAsDataURL(file){
    return new Promise((ok,ng)=>{ const r=new FileReader(); r.onload=()=>ok(r.result); r.onerror=ng; r.readAsDataURL(file); });
  }
  function loadImage(url){
    return new Promise((ok,ng)=>{ const i=new Image(); i.onload=()=>ok(i); i.onerror=ng; i.src=url; });
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  render();
</script>
</body>
</html>
